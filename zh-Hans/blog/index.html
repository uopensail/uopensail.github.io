<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Blog | RecGo</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.uopensail.com/zh-Hans/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://docs.uopensail.com/zh-Hans/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://docs.uopensail.com/zh-Hans/blog"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en_GB"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | RecGo"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/zh-Hans/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.uopensail.com/zh-Hans/blog"><link data-rh="true" rel="alternate" href="https://docs.uopensail.com/blog" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://docs.uopensail.com/zh-Hans/blog" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://docs.uopensail.com/blog" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://docs.uopensail.com/zh-Hans/blog","mainEntityOfPage":"https://docs.uopensail.com/zh-Hans/blog","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://docs.uopensail.com/zh-Hans/blog/OneEpochInRecAlgo","mainEntityOfPage":"https://docs.uopensail.com/zh-Hans/blog/OneEpochInRecAlgo","url":"https://docs.uopensail.com/zh-Hans/blog/OneEpochInRecAlgo","headline":"The One Epoch Phenomenon in Recommendation Algorithms","name":"The One Epoch Phenomenon in Recommendation Algorithms","description":"In the field of Click-Through Rate (CTR) prediction and recommendation systems, the \"ONE EPOCH phenomenon\" refers to the overfitting phenomenon where deep models achieve optimal generalization performance after only one epoch of training, and continued training leads to a sharp decline in performance on the test set.","datePublished":"2025-03-29T04:45:30.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://docs.uopensail.com/zh-Hans/blog/RecGo 如何实现内存管理优化：化零为整的工程实践","mainEntityOfPage":"https://docs.uopensail.com/zh-Hans/blog/RecGo 如何实现内存管理优化：化零为整的工程实践","url":"https://docs.uopensail.com/zh-Hans/blog/RecGo 如何实现内存管理优化：化零为整的工程实践","headline":"RecGo 如何实现内存管理优化：化零为整的工程实践","name":"RecGo 如何实现内存管理优化：化零为整的工程实践","description":"概述","datePublished":"2025-03-29T04:45:30.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://docs.uopensail.com/zh-Hans/blog/倒排召回的设计","mainEntityOfPage":"https://docs.uopensail.com/zh-Hans/blog/倒排召回的设计","url":"https://docs.uopensail.com/zh-Hans/blog/倒排召回的设计","headline":"倒排召回系统设计","name":"倒排召回系统设计","description":"倒排索引","datePublished":"2025-03-29T04:45:30.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://docs.uopensail.com/zh-Hans/blog/AppS/DeepFM","mainEntityOfPage":"https://docs.uopensail.com/zh-Hans/blog/AppS/DeepFM","url":"https://docs.uopensail.com/zh-Hans/blog/AppS/DeepFM","headline":"Application of DeepFM Model in AppS","name":"Application of DeepFM Model in AppS","description":"In the field of recommendation systems, efficiently combining low-order and high-order feature interactions to improve prediction accuracy has always been a key challenge. The DeepFM model offers a solution that combines memory capacity and generalization ability by integrating Factorization Machines (FM) with Deep Neural Networks (DNN). This article will introduce the application and effectiveness of DeepFM in the AppS business.","datePublished":"2025-03-29T04:45:30.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://docs.uopensail.com/zh-Hans/blog/AppS/ESMM","mainEntityOfPage":"https://docs.uopensail.com/zh-Hans/blog/AppS/ESMM","url":"https://docs.uopensail.com/zh-Hans/blog/AppS/ESMM","headline":"Application of the ESMM Model in AppS","name":"Application of the ESMM Model in AppS","description":"In modern recommendation systems, particularly within the AppS business environment, predicting user behaviors such as Click-Through Rate (CTR) and Conversion Rate (CVR) is crucial for enhancing user satisfaction and driving business growth. The ESMM model, with its unique architecture and efficient multi-task learning capability, offers an outstanding solution for the AppS business.","datePublished":"2025-03-29T04:45:30.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://docs.uopensail.com/zh-Hans/blog/AppS/FM","mainEntityOfPage":"https://docs.uopensail.com/zh-Hans/blog/AppS/FM","url":"https://docs.uopensail.com/zh-Hans/blog/AppS/FM","headline":"Application of FM Model in AppS","name":"Application of FM Model in AppS","description":"Introduction","datePublished":"2025-03-29T04:45:30.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://docs.uopensail.com/zh-Hans/blog/AppS/MMOE","mainEntityOfPage":"https://docs.uopensail.com/zh-Hans/blog/AppS/MMOE","url":"https://docs.uopensail.com/zh-Hans/blog/AppS/MMOE","headline":"Application of the MMOE Model in AppS","name":"Application of the MMOE Model in AppS","description":"In the AppS business, recommendation systems need not only to improve user Click-Through Rate (CTR) but also to enhance Conversion Rate (CVR) to achieve comprehensive user engagement and business growth. The Multi-gate Mixture-of-Experts (MMOE) model offers an efficient solution by simultaneously optimizing multiple objectives to meet these business needs.","datePublished":"2025-03-29T04:45:30.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://docs.uopensail.com/zh-Hans/blog/AppS/intro","mainEntityOfPage":"https://docs.uopensail.com/zh-Hans/blog/AppS/intro","url":"https://docs.uopensail.com/zh-Hans/blog/AppS/intro","headline":"Applicaton Store(AppS) Introduction","name":"Applicaton Store(AppS) Introduction","description":"Apps functions as a digital distribution platform similar to Apple's AppStore or Google Play, focusing on providing users with a variety of applications and games. Our primary key performance indicator is the number of user downloads and installations, which directly reflects the platform's usage and user satisfaction.","datePublished":"2025-03-29T04:45:30.000Z","author":[],"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/zh-Hans/blog/rss.xml" title="RecGo RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-Hans/blog/atom.xml" title="RecGo Atom Feed"><link rel="stylesheet" href="/zh-Hans/assets/css/styles.0ed5b343.css">
<script src="/zh-Hans/assets/js/runtime~main.9576a954.js" defer="defer"></script>
<script src="/zh-Hans/assets/js/main.3e7f77c9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/zh-Hans/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.uopensail.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/zh-Hans/img/logo.svg" alt="RecGo Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh-Hans/img/logo.svg" alt="RecGo Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">RecGo</b></a><a class="navbar__item navbar__link" href="/zh-Hans/docs/best-practices/Ecommerce-Frequency-Control-Configuration-Guide">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-Hans/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-Hans/blog/OneEpochInRecAlgo">The One Epoch Phenomenon in Recommendation Algorithms</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-Hans/blog/RecGo 如何实现内存管理优化：化零为整的工程实践">RecGo 如何实现内存管理优化：化零为整的工程实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-Hans/blog/倒排召回的设计">倒排召回系统设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-Hans/blog/AppS/DeepFM">Application of DeepFM Model in AppS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-Hans/blog/AppS/ESMM">Application of the ESMM Model in AppS</a></li></ul></div></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh-Hans/blog/OneEpochInRecAlgo">The One Epoch Phenomenon in Recommendation Algorithms</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-03-29T04:45:30.000Z">2025年3月29日</time> · <!-- -->阅读需 3 分钟</div></header><div class="markdown"><p>In the field of Click-Through Rate (CTR) prediction and recommendation systems, the &quot;ONE EPOCH phenomenon&quot; refers to the overfitting phenomenon where deep models achieve optimal generalization performance after only one epoch of training, and continued training leads to a sharp decline in performance on the test set.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="phenomenon-characteristics">Phenomenon Characteristics<a href="#phenomenon-characteristics" class="hash-link" aria-label="Phenomenon Characteristics的直接链接" title="Phenomenon Characteristics的直接链接">​</a></h2>
<ul>
<li>Performance During Training‌</li>
</ul>
<p>The model reaches a peak AUC on the test set at the end of the first epoch, and performance rapidly declines after the start of the second epoch.
Overfitting manifests as a continuous decrease in training loss, but validation set metrics (such as AUC) significantly deteriorate after one epoch.</p>
<ul>
<li>Relevance to Industrial Practice‌</li>
</ul>
<p>This phenomenon explains why many industrial-grade recommendation systems stop training after only one epoch of data, rather than following the multiple iterations typical of traditional deep learning.</p>
<center>
<img decoding="async" loading="lazy" title="" src="../../static/images/one-epoch-1.png" alt="" width="268" data-align="center" class="img_ev3q">
<img decoding="async" loading="lazy" title="" src="../../static/images/one-epoch-2.png" alt="" width="261" data-align="center" class="img_ev3q">
</center>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="key-causes">Key Causes<a href="#key-causes" class="hash-link" aria-label="Key Causes的直接链接" title="Key Causes的直接链接">​</a></h2>
<ul>
<li>Feature Sparsity‌</li>
</ul>
<p><strong>The high number of IDs in feature domains</strong> (such as user IDs, product IDs) results in extremely low frequencies of occurrence for each ID, making the model prone to memorizing sparse samples rather than generalizing.
The Embedding layer corresponding to sparse features overfits low-frequency IDs during multiple training epochs.</p>
<ul>
<li>Model Optimization Characteristics‌</li>
</ul>
<p><strong>Strong optimizers (such as Adam) and larger learning rates</strong> accelerate convergence, enabling the model to complete effective learning within one epoch, with subsequent training falling into local overfitting.
Complex model structures (such as deep networks) with excessive capacity exacerbate the memorization of noise/sparse features.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mitigation-strategies">Mitigation Strategies<a href="#mitigation-strategies" class="hash-link" aria-label="Mitigation Strategies的直接链接" title="Mitigation Strategies的直接链接">​</a></h2>
<ul>
<li>Feature Engineering Optimization‌</li>
</ul>
<p>Reduce Sparsity‌: Merge low-frequency IDs, use default values to replace sparse IDs, reduce hash space.
Dynamic Feature Filtering‌: Dynamically adjust the participation intensity of sparse features based on the training stage.</p>
<ul>
<li>Training Parameter Adjustment‌</li>
</ul>
<p>Limit Training Epochs‌: Force training to stop after only one epoch.
Learning Rate Control‌: Use a smaller initial learning rate or a learning rate decay strategy.</p>
<ul>
<li>Model Structure Improvement‌</li>
</ul>
<p>Simplify the Embedding layer or introduce regularization (such as Dropout) to suppress overfitting.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="insights-from-industrial-practice">Insights from Industrial Practice<a href="#insights-from-industrial-practice" class="hash-link" aria-label="Insights from Industrial Practice的直接链接" title="Insights from Industrial Practice的直接链接">​</a></h2>
<ul>
<li>Strong Correlation with Data Distribution‌</li>
</ul>
<p>This phenomenon is particularly significant in high-sparsity business scenarios (such as advertising recommendations, e-commerce CTR prediction), but rarely occurs in dense data tasks.</p>
<ul>
<li>Priority of Optimization Directions‌</li>
</ul>
<p>The industrial community tends to directly avoid the problem through feature engineering and early stopping strategies, rather than modifying the model structure.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="theoretical-hypotheses">Theoretical Hypotheses<a href="#theoretical-hypotheses" class="hash-link" aria-label="Theoretical Hypotheses的直接链接" title="Theoretical Hypotheses的直接链接">​</a></h2>
<p>Some studies suggest that the ONE EPOCH phenomenon may stem from the dynamic balance between sample memorization and generalization: in the first epoch, the model completes coarse-grained learning of key features, and subsequent training disrupts generalization ability due to over-refinement of local features.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading">Further Reading<a href="#further-reading" class="hash-link" aria-label="Further Reading的直接链接" title="Further Reading的直接链接">​</a></h2>
<p><a href="https://arxiv.org/pdf/2209.06053" target="_blank" rel="noopener noreferrer">Towards Understanding the Overfitting Phenomenon of Deep Click-Through Rate Prediction Models</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/669063912" target="_blank" rel="noopener noreferrer">Ali&#x27;s OneEpoch VS KuaiShou&#x27;s MultiEpoch</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh-Hans/blog/RecGo 如何实现内存管理优化：化零为整的工程实践">RecGo 如何实现内存管理优化：化零为整的工程实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-03-29T04:45:30.000Z">2025年3月29日</time> · <!-- -->阅读需 6 分钟</div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概述">概述<a href="#概述" class="hash-link" aria-label="概述的直接链接" title="概述的直接链接">​</a></h2>
<p>在RecGo推荐系统的核心架构中，物料特征的内存管理一直是性能优化的重点（详见《RecGo特征系统设计原理》）。我们采用内存驻留方案实现了亚毫秒级特征访问，但在实际落地过程中发现了新的挑战：动态加载海量物料特征时，频繁创建的内存碎片对象导致Go GC出现严重性能瓶颈。本文将深入解析我们如何通过创新内存分配方案彻底解决该问题。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题分析小对象引发的gc风暴">问题分析：小对象引发的GC风暴<a href="#问题分析小对象引发的gc风暴" class="hash-link" aria-label="问题分析：小对象引发的GC风暴的直接链接" title="问题分析：小对象引发的GC风暴的直接链接">​</a></h2>
<p>数据规模与内存特征</p>
<p>在千万级物料场景下，每个物料包含50-100个异构特征，具体构成如下：</p>













































<table><thead><tr><th>特征类型</th><th style="text-align:right">内存占比</th><th style="text-align:right">平均内存占用</th></tr></thead><tbody><tr><td></td><td style="text-align:right"></td><td style="text-align:right"></td></tr><tr><td>int64</td><td style="text-align:right">25%</td><td style="text-align:right">8 B</td></tr><tr><td>float32</td><td style="text-align:right">20%</td><td style="text-align:right">4 B</td></tr><tr><td>string</td><td style="text-align:right">30%</td><td style="text-align:right">32 B</td></tr><tr><td>[]int64</td><td style="text-align:right">15%</td><td style="text-align:right">128 B</td></tr><tr><td>[]float32</td><td style="text-align:right">5%</td><td style="text-align:right">64 B</td></tr><tr><td>[]string</td><td style="text-align:right">5%</td><td style="text-align:right">256 B</td></tr></tbody></table>
<p>每次全量更新物料池会生成约1.2亿个内存对象，其中90%的对象大小小于512字节。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gc性能瓶颈实测">GC性能瓶颈实测<a href="#gc性能瓶颈实测" class="hash-link" aria-label="GC性能瓶颈实测的直接链接" title="GC性能瓶颈实测的直接链接">​</a></h3>
<p>在Go 1.21环境下进行压力测试，得到以下关键指标：</p>

























<table><thead><tr><th>指标</th><th style="text-align:right">常规分配</th><th style="text-align:right">Arena方案</th></tr></thead><tbody><tr><td>GC暂停时间（P99）</td><td style="text-align:right">420ms</td><td style="text-align:right">8ms</td></tr><tr><td>内存分配次数/s</td><td style="text-align:right">5.2M</td><td style="text-align:right">0.8M</td></tr><tr><td>内存碎片率</td><td style="text-align:right">38%</td><td style="text-align:right">4%</td></tr></tbody></table>
<p>测试结果显示，高频小对象分配导致GC工作负载激增，在业务高峰期频繁触发GC STW（Stop-The-World），严重影响服务稳定性。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案选型与技术论证">解决方案选型与技术论证<a href="#解决方案选型与技术论证" class="hash-link" aria-label="解决方案选型与技术论证的直接链接" title="解决方案选型与技术论证的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cgo方案可行性分析">CGO方案可行性分析<a href="#cgo方案可行性分析" class="hash-link" aria-label="CGO方案可行性分析的直接链接" title="CGO方案可行性分析的直接链接">​</a></h3>
<p>初步设想采用C++实现特征管理模块，通过CGO桥接。性能测试可以参考网页
<a href="https://shane.ai/posts/cgo-performance-in-go1.21/" target="_blank" rel="noopener noreferrer">CGO Performance In Go 1.21</a></p>
<blockquote>
<p>Conclusions<br>
So at this point we’ve measured performance overhead of Cgo, at least in terms of wall clock time (note that we haven’t looked at memory/thread count/battery usage/etc). We know that the overhead is on the order of 2 mutex operations and that it does scale with number of cores up to around 16. We’ve also seen that with 16 cores we can do around 4ns/op or close to 250 million Cgo ops/s. So if I was looking at using Cgo in 2023 I’d definitely use it outside of very hot loops. There’s many reasons I wouldn’t use Cgo in 2023 (see disclaimer), but performance is unlikely to be one of them.<br>
I’ll end with this little Cgo version of “latency numbers every programmer should know” table:</p>



































<table><thead><tr><th>Go/Cgo latency</th><th style="text-align:right"></th><th style="text-align:right"></th></tr></thead><tbody><tr><td>Benchmark Name</td><td style="text-align:right">1 Core</td><td style="text-align:right">16 Cores</td></tr><tr><td>Inlined Empty func</td><td style="text-align:right">0.271 ns</td><td style="text-align:right">0.02489 ns</td></tr><tr><td>Empty func</td><td style="text-align:right">1.5 ns</td><td style="text-align:right">0.135 ns</td></tr><tr><td>cgo</td><td style="text-align:right">40 ns</td><td style="text-align:right">4.281 ns</td></tr><tr><td>encoding/json int parse</td><td style="text-align:right">52.89 ns</td><td style="text-align:right">5.518 ns</td></tr></tbody></table>
</blockquote>
<p>基于上面的测试结果，我们认为特征存储使用cgo是不太合适的，因为特征的读取非常频繁。即在量级非常大的时候，频繁进行栈切换会导致耗时增加，影响整体性能。因此，我们最终没有选择这个方案。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="arena内存池化方案">Arena内存池化方案<a href="#arena内存池化方案" class="hash-link" aria-label="Arena内存池化方案的直接链接" title="Arena内存池化方案的直接链接">​</a></h3>
<p>基于物料池只读特性，我们创新性地提出以下设计原则：</p>
<ol>
<li>连续内存分配‌：预分配大块内存（4KB pages）</li>
<li>对象生命周期绑定‌：特征对象与所属物料池同生命周期</li>
<li>批量释放机制‌：物料池更新时整块释放内存</li>
</ol>
<p>架构对比示意图：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">传统方案：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[obj1][padding][obj2][obj3][padding]... -&gt; 内存碎片</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Arena方案：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[page1: obj1|obj2|obj3...][page2: obj4|obj5...] -&gt; 连续内存</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现细节与核心算法">实现细节与核心算法<a href="#实现细节与核心算法" class="hash-link" aria-label="实现细节与核心算法的直接链接" title="实现细节与核心算法的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="内存分配器设计">内存分配器设计<a href="#内存分配器设计" class="hash-link" aria-label="内存分配器设计的直接链接" title="内存分配器设计的直接链接">​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pageSize       </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 4KB对齐现代CPU缓存行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxSmallAlloc  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">512</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 小对象阈值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Arena </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mu     sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RWMutex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pages  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// 内存页池</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curPtr </span><span class="token builtin">uintptr</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 当前页偏移量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curCap </span><span class="token builtin">int</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 当前页剩余容量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 分配算法伪代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Arena</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Alloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align </span><span class="token builtin">uintptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mu</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mu</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 计算对齐偏移</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    offset </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">curPtr </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> align </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;^</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">align </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> size </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> maxSmallAlloc </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">allocLarge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> offset</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">curCap </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newPage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">curPtr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ptr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pages</span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pages</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">offset </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> offset</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">curPtr </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ptr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="复杂类型序列化方案">复杂类型序列化方案<a href="#复杂类型序列化方案" class="hash-link" aria-label="复杂类型序列化方案的直接链接" title="复杂类型序列化方案的直接链接">​</a></h4>
<p>以[]string类型为例，内存布局实现：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sliceHeader (24B)     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Data *stringHeader  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Len  int            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Cap  int            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| stringHeader (16B)    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Data *byte          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Len  int            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| stringHeader          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   ...                 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 实际字符串数据区       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| &quot;value1&quot;|&quot;value2&quot;|... |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>序列化步骤：</p>
<ol>
<li>预计算总内存需求（包含所有对齐填充）</li>
<li>分配连续内存块</li>
<li>按序写入实际字符串数据</li>
<li>构建stringHeader数组</li>
<li>初始化sliceHeader</li>
</ol>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 伪代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">MarshalStrings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arena </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Arena</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> values </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 1. 计算总需求</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">16</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 头部空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> values </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        total </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 2. 分配内存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> arena</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Alloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">total</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 3. 写入字符串内容</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...（细节省略）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 4. 构建string headers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...（细节省略）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsafe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">sliceHeader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh-Hans/blog/倒排召回的设计">倒排召回系统设计</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-03-29T04:45:30.000Z">2025年3月29日</time> · <!-- -->阅读需 7 分钟</div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="倒排索引">倒排索引<a href="#倒排索引" class="hash-link" aria-label="倒排索引的直接链接" title="倒排索引的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="基本定义">基本定义<a href="#基本定义" class="hash-link" aria-label="基本定义的直接链接" title="基本定义的直接链接">​</a></h3>
<p>倒排索引（Inverted Index）是一种将内容映射到文档位置的索引结构，本质是&quot;词项→文档&quot;的逆向映射关系。与正排索引（文档→内容）形成互补。</p>
<center>
<img decoding="async" loading="lazy" src="../static/images/Inverted-Index.jpg" width="522" class="img_ev3q">
</center>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="核心组成">核心组成<a href="#核心组成" class="hash-link" aria-label="核心组成的直接链接" title="核心组成的直接链接">​</a></h3>
<ul>
<li><strong>词典（Term Dictionary）</strong>：所有唯一词项的排序集合</li>
<li><strong>倒排列表（Posting List）</strong>：每个词项对应的文档ID序列</li>
<li><strong>位置信息（Position）</strong>：可选存储词项在文档中的具体位置</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="索引结构类型">索引结构类型<a href="#索引结构类型" class="hash-link" aria-label="索引结构类型的直接链接" title="索引结构类型的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-基本倒排索引">1. 基本倒排索引<a href="#1-基本倒排索引" class="hash-link" aria-label="1. 基本倒排索引的直接链接" title="1. 基本倒排索引的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[词项A] → [文档1, 文档3, 文档5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[词项B] → [文档2, 文档4]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="带权倒排索引">带权倒排索引<a href="#带权倒排索引" class="hash-link" aria-label="带权倒排索引的直接链接" title="带权倒排索引的直接链接">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;机器学习&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;doc_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">101</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;weight&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.95</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;doc_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">205</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;weight&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.87</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="多维倒排索引">多维倒排索引<a href="#多维倒排索引" class="hash-link" aria-label="多维倒排索引的直接链接" title="多维倒排索引的直接链接">​</a></h3>
<p>支持复合键的索引形式：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;价格区间_品类&quot; → [商品ID列表]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="召回机制概述">召回机制概述<a href="#召回机制概述" class="hash-link" aria-label="召回机制概述的直接链接" title="召回机制概述的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="常见召回类型及触发逻辑">常见召回类型及触发逻辑<a href="#常见召回类型及触发逻辑" class="hash-link" aria-label="常见召回类型及触发逻辑的直接链接" title="常见召回类型及触发逻辑的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="i2iitem-to-item-eg-icf召回">I2I(Item-To-Item, e.g: ICF)召回<a href="#i2iitem-to-item-eg-icf召回" class="hash-link" aria-label="I2I(Item-To-Item, e.g: ICF)召回的直接链接" title="I2I(Item-To-Item, e.g: ICF)召回的直接链接">​</a></h4>
<ul>
<li>
<p><strong>核心逻辑</strong>：
通过用户历史交互物品作为初始查询种子，触发多阶段召回过程。首先获取用户近期有过交互行为的物品集合作为初始查询键，随后基于预构建的物品相似度矩阵进行近邻扩展，获取与种子物品最相关的候选物品集合。在工程实现层面，典型的i2i召回系统会采用并行查询架构，将用户的历史物品集合分片后并发查询相似矩阵，最后通过聚合算子（轮转式去重合并）合并各分片的召回结果，形成最终的候选物品集合。</p>
</li>
<li>
<p>深度阅读可以参考下面的网页：</p>
<ul>
<li><a href="https://www.geeksforgeeks.org/collaborative-filtering-ml/" target="_blank" rel="noopener noreferrer">Collaborative Filtering in Machine Learning</a></li>
<li><a href="https://www.ibm.com/think/topics/collaborative-filtering" target="_blank" rel="noopener noreferrer">How collaborative filtering works</a></li>
<li><a href="https://mlarchive.com/machine-learning/collaborative-filtering-recommendation-system/" target="_blank" rel="noopener noreferrer">Collaborative Filtering Recommendation System</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/653379602" target="_blank" rel="noopener noreferrer">一文说尽协同过滤算法中的相似度计算</a></li>
</ul>
</li>
<li>
<p><strong>存储示例</strong>：</p>
</li>
</ul>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;item_sim_123&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 商品123的相似列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;456&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0.85</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;789&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0.76</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">...</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 按相似度降序存储</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="用户画像召回">用户画像召回<a href="#用户画像召回" class="hash-link" aria-label="用户画像召回的直接链接" title="用户画像召回的直接链接">​</a></h4>
<ul>
<li><strong>核心逻辑</strong></li>
</ul>
<p>用户画像的核心在于标签化，即通过标签体系对用户特征进行结构化表征，从而更精确地刻画用户属性。兴趣标签仅是其中一种维度，完整的用户画像通常涵盖自然属性（如年龄、性别）、社会属性（如职业、地域）、业务属性（如消费频次、客单价）、设备属性（如终端型号、操作系统）等多个方面。在构建用户画像标签体系后，用户画像标签作为查询键检索倒排索引，实现从特征到候选集的精准召回。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h3>
<p>上述召回过程的核心机制是通过用户特征生成查询键，进而检索倒排索引。基于这一原理，我们设计了以下方案。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="系统架构设计">系统架构设计<a href="#系统架构设计" class="hash-link" aria-label="系统架构设计的直接链接" title="系统架构设计的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="核心处理流水线">核心处理流水线<a href="#核心处理流水线" class="hash-link" aria-label="核心处理流水线的直接链接" title="核心处理流水线的直接链接">​</a></h3>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="关键组件说明">关键组件说明<a href="#关键组件说明" class="hash-link" aria-label="关键组件说明的直接链接" title="关键组件说明的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="查询键生成工具minia">查询键生成工具:<a href="https://github.com/uopensail/minia" target="_blank" rel="noopener noreferrer">Minia</a><a href="#查询键生成工具minia" class="hash-link" aria-label="查询键生成工具minia的直接链接" title="查询键生成工具minia的直接链接">​</a></h4>
<p>Minia 是一个高效的 C++ 特征处理库，专注于通过表达式驱动的方式实现一致且灵活的特征转换。用户只需在配置文件中定义表达式规则，即可自动应用于召回、模型训练和推理等，确保数据处理逻辑严格一致，避免特征偏差。</p>
<ul>
<li>
<p>核心优势：表达式处理
自定义表达式语法：基于 ANTLR 实现，支持复杂数学、统计、字符串及日期运算（如 sqrt(x), bucket(age, [0,18,60])）。</p>
</li>
<li>
<p>智能优化：自动进行常量折叠、公共子表达式消除等优化，减少冗余计算，提升执行效率。</p>
</li>
<li>
<p>动态类型转换：支持 cast() 等操作，灵活处理多类型数据（数值、向量、字符串等）。</p>
</li>
<li>
<p>简洁配置，统一流程</p>
</li>
</ul>
<p>TOML 配置：通过声明式规则定义特征变换，如：</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[transform]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">expressions = [&#x27;user_gender_cat1 = concat(gender, cat1_prefer)&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">features = [&quot;user_gender_cat1&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="轮转式去重合并round-robin-merge">轮转式去重合并(Round Robin Merge)<a href="#轮转式去重合并round-robin-merge" class="hash-link" aria-label="轮转式去重合并(Round Robin Merge)的直接链接" title="轮转式去重合并(Round Robin Merge)的直接链接">​</a></h4>
<p>依次从各召回列表中选取元素，确保结果兼具多样性和有序性。</p>
<ul>
<li>
<p>去重优先：自动跳过已存在元素，避免冗余。</p>
</li>
<li>
<p>轮转均衡：按轮次平等分配各召回源的曝光机会，兼顾多样性。</p>
</li>
<li>
<p>顺序保留：在全局去重基础上，尽量维持各列表内部排序。</p>
</li>
</ul>
<p>假设有3个召回通道：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">召回1: [A, B, C]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">召回2: [B, D]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">召回3: [A, E]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">合并过程：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. 第一轮：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 召回1取A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 召回2取B </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 召回3取A(跳过，已存在)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → 结果：[A, B]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 第二轮：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 召回1取B(跳过)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 召回2取D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 召回3取E</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → 结果：[A, B, D, E]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 第三轮：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 召回1取C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 召回2已耗尽</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 召回3已耗尽</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → 最终结果：[A, B, D, E, C]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh-Hans/blog/AppS/DeepFM">Application of DeepFM Model in AppS</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-03-29T04:45:30.000Z">2025年3月29日</time> · <!-- -->阅读需 5 分钟</div></header><div class="markdown"><p>In the field of recommendation systems, efficiently combining low-order and high-order feature interactions to improve prediction accuracy has always been a key challenge. The DeepFM model offers a solution that combines memory capacity and generalization ability by integrating Factorization Machines (FM) with Deep Neural Networks (DNN). This article will introduce the application and effectiveness of DeepFM in the AppS business.</p>
<center>
<img decoding="async" loading="lazy" src="../../static/images/deepfm.svg" title="" alt="" width="400" data-align="center" class="img_ev3q">
</center>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Introduction的直接链接" title="Introduction的直接链接">​</a></h2>
<p>DeepFM (Deep Factorization Machine) is a recommendation system model that combines factorization machines (FM) with deep learning. It aims to capture both low-order and high-order feature interactions simultaneously. The architecture of DeepFM consists of two components: the FM component and the Deep component. The FM component is used to capture low-order feature interactions, while the Deep component learns high-order feature interactions through a multi-layer perceptron (MLP).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fm-module">FM Module<a href="#fm-module" class="hash-link" aria-label="FM Module的直接链接" title="FM Module的直接链接">​</a></h3>
<ul>
<li><strong>Function</strong>: The FM module focuses on capturing second-order interactions between features. It leverages feature embeddings to compute interaction terms and efficiently represent relationships between sparse features.</li>
<li><strong>Advantage</strong>: By modeling low-order interactions, the FM module effectively handles sparse data, making it particularly suitable for scenarios with a large number of sparse features.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dnn-module">DNN Module<a href="#dnn-module" class="hash-link" aria-label="DNN Module的直接链接" title="DNN Module的直接链接">​</a></h3>
<ul>
<li><strong>Function</strong>: The DNN module is used to learn high-order feature combinations. Through a multi-layer neural network, DNN can capture complex nonlinear feature interactions.</li>
<li><strong>Customization Capability</strong>: Users can design the network structure of the DNN according to specific needs, including the number of layers, the number of neurons in each layer, activation functions, and regularization strategies.</li>
<li><strong>Advantage</strong>: With a flexible structure design, the DNN module can generalize to new feature combinations and improve the model&#x27;s adaptability to different data distributions.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="benefits-of-deepfm-over-fm">Benefits of DeepFM over FM<a href="#benefits-of-deepfm-over-fm" class="hash-link" aria-label="Benefits of DeepFM over FM的直接链接" title="Benefits of DeepFM over FM的直接链接">​</a></h3>
<ol>
<li>
<p><strong>Comprehensive Feature Interaction Capability</strong>: Traditional FM models mainly focus on second-order interactions between features, whereas DeepFM can effectively capture high-order feature interactions by introducing a deep learning component, thus improving recommendation accuracy.</p>
</li>
<li>
<p><strong>No Need for Manual Feature Engineering</strong>: DeepFM can automatically learn feature interactions, reducing the reliance on manual feature engineering, which is particularly useful for handling complex, large-scale datasets.</p>
</li>
<li>
<p><strong>Shared Feature Embeddings</strong>: The feature embedding layer in DeepFM is shared between the FM and Deep components, making the model more efficient in capturing feature interactions while reducing the number of model parameters.</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="advantages-of-deepfm">Advantages of DeepFM<a href="#advantages-of-deepfm" class="hash-link" aria-label="Advantages of DeepFM的直接链接" title="Advantages of DeepFM的直接链接">​</a></h3>
<ul>
<li><strong>Comprehensive Capability</strong>: DeepFM combines the strengths of FM and DNN, allowing it to learn both low-order and high-order feature interactions without the need for feature engineering.</li>
<li><strong>Model Simplicity</strong>: Compared to training FM and DNN separately and then combining them, DeepFM maintains model compactness and efficiency by sharing the feature embedding layer.</li>
<li><strong>Wide Applicability</strong>: Due to its flexibility and strong expressive power, DeepFM is widely used in fields such as ad click-through rate prediction and recommendation systems.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-code-for-developing-deepfm-with-pytorch">Example Code for Developing DeepFM with PyTorch<a href="#example-code-for-developing-deepfm-with-pytorch" class="hash-link" aria-label="Example Code for Developing DeepFM with PyTorch的直接链接" title="Example Code for Developing DeepFM with PyTorch的直接链接">​</a></h3>
<p>In the following example, we will develop the FM and DNN modules separately and then combine them into a complete DeepFM model.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nn </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">functional </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">DeepFM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> field_dims</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> embed_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mlp_dims</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DeepFM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ModuleList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Embedding</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> embed_dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> dim </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> field_dims</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">linear </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">field_dims</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">embed_dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dnn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DNN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">field_dims</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> embed_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mlp_dims</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_emb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">emb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> emb </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embeddings</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_emb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_emb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_linear </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_fm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_emb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_dnn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dnn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_emb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">view</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_emb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> x_linear </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> x_fm </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> x_dnn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">FM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> embed_dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embed_dim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> embed_dim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        square_of_sum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">**</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sum_of_square </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">**</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">square_of_sum </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> sum_of_square</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keepdim</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">DNN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dims</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DNN</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        layers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> dim </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> dims</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            layers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            layers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ReLU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            input_dim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sequential</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">layers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Example usage:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">field_dims </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Example field dimensions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">embed_dim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mlp_dims </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DeepFM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">field_dims</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> embed_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mlp_dims</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Dummy input</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">field_dims</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Batch size 4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="application">Application<a href="#application" class="hash-link" aria-label="Application的直接链接" title="Application的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-feature-embedding-configuration">1. Feature Embedding Configuration<a href="#1-feature-embedding-configuration" class="hash-link" aria-label="1. Feature Embedding Configuration的直接链接" title="1. Feature Embedding Configuration的直接链接">​</a></h3>
<p>In our DeepFM model, the embedding dimension for each feature is set to 10. This configuration effectively captures low-order feature interactions and provides a solid foundation for subsequent high-order feature learning through the deep neural network.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-model-training-and-optimization">2. Model Training and Optimization<a href="#2-model-training-and-optimization" class="hash-link" aria-label="2. Model Training and Optimization的直接链接" title="2. Model Training and Optimization的直接链接">​</a></h3>
<p>Building on our experience with FM model training, the DeepFM model excels in combining memory and generalization. The FM component captures low-order feature interactions, while the DNN component learns high-order feature combinations. This combination achieves excellent results in the current business scenario.</p>
<ul>
<li>
<p>Memory Capability: DeepFM uses the FM component&#x27;s low-order interactions to capture known, stable feature combinations.</p>
</li>
<li>
<p>Generalization Capability: Through the DNN component, DeepFM can discover new, potential high-order feature combinations, enhancing the prediction of user behavior.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-ab-testing-results">3. AB Testing Results<a href="#3-ab-testing-results" class="hash-link" aria-label="3. AB Testing Results的直接链接" title="3. AB Testing Results的直接链接">​</a></h3>
<p>In the &quot;Guess You Like&quot; module, deploying the DeepFM model led to a <strong>4.66%</strong> increase in average distribution per user. This result indicates that DeepFM significantly enhances the quality of personalized recommendations for users.</p>
<center>
<img decoding="async" loading="lazy" src="../../static/images/DeepFM-AB.png" title="" alt="" width="522" data-align="center" class="img_ev3q">
</center>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading">Further Reading<a href="#further-reading" class="hash-link" aria-label="Further Reading的直接链接" title="Further Reading的直接链接">​</a></h2>
<p><a href="https://arxiv.org/abs/1703.04247" target="_blank" rel="noopener noreferrer">A Factorization-Machine based Neural Network for CTR Prediction - arXiv</a></p>
<p><a href="https://d2l.ai/chapter_recommender-systems/deepfm.html" target="_blank" rel="noopener noreferrer">Deep Factorization Machines — Dive into Deep Learning</a></p>
<p><a href="https://medium.com/data-science-in-your-pocket/deepfm-for-recommendation-systems-explained-with-codes-c200063990f7" target="_blank" rel="noopener noreferrer">DeepFM for recommendation systems explained with codes</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh-Hans/blog/AppS/ESMM">Application of the ESMM Model in AppS</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-03-29T04:45:30.000Z">2025年3月29日</time> · <!-- -->阅读需 4 分钟</div></header><div class="markdown"><p>In modern recommendation systems, particularly within the AppS business environment, predicting user behaviors such as Click-Through Rate (CTR) and Conversion Rate (CVR) is crucial for enhancing user satisfaction and driving business growth. The ESMM model, with its unique architecture and efficient multi-task learning capability, offers an outstanding solution for the AppS business.</p>
<center>
<img decoding="async" loading="lazy" title="" src="../../static/images/ESMM-origin.webp" alt="" width="400" data-align="center" class="img_ev3q">
</center>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Introduction的直接链接" title="Introduction的直接链接">​</a></h2>
<p>ESMM, short for Entire Space Multi-task Model, is a multi-task learning model specifically designed to tackle problems related to ad recommendations and user behavior prediction. The core idea of ESMM is to enhance the overall performance of the model by simultaneously learning multiple related tasks. This approach not only shares potential information between different tasks but also effectively alleviates the issue of data sparsity.</p>
<p>The ESMM model is typically applied to predict CTR and CVR. Traditional methods often train two separate models to predict CTR and CVR, whereas ESMM simultaneously performs these two prediction tasks within a unified framework, thereby capturing the correlation between them more effectively.</p>
<p>To learn more about the foundational concepts of ESMM, you can read this <a href="https://arxiv.org/abs/1804.07931" target="_blank" rel="noopener noreferrer">academic paper on ESMM</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="major-advantages-of-esmm">Major Advantages of ESMM<a href="#major-advantages-of-esmm" class="hash-link" aria-label="Major Advantages of ESMM的直接链接" title="Major Advantages of ESMM的直接链接">​</a></h3>
<ul>
<li><strong>Data Efficiency</strong>: By sharing the feature space, ESMM can better utilize data, especially in sparse data scenarios.</li>
<li><strong>Performance Enhancement</strong>: By jointly learning multiple tasks, ESMM can better capture the mutual influences between related tasks, improving the accuracy of predictions.</li>
<li><strong>Simplified Architecture</strong>: Compared to training multiple models independently, ESMM provides a more streamlined and efficient solution.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="differences-between-esmm-and-mmoe">Differences Between ESMM and MMOE<a href="#differences-between-esmm-and-mmoe" class="hash-link" aria-label="Differences Between ESMM and MMOE的直接链接" title="Differences Between ESMM and MMOE的直接链接">​</a></h3>
<p>In multi-task learning, besides ESMM, there is another popular model known as MMOE (Multi-gate Mixture-of-Experts). Both MMOE and ESMM aim to enhance the performance of multiple tasks by sharing information, but they exhibit significant differences in architecture and application scenarios:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="architectural-differences">Architectural Differences<a href="#architectural-differences" class="hash-link" aria-label="Architectural Differences的直接链接" title="Architectural Differences的直接链接">​</a></h4>
<ul>
<li>
<p><strong>ESMM</strong>: ESMM conducts multi-task learning by sharing the entire feature space. It primarily uses a unified network structure to simultaneously predict multiple tasks (such as CTR and CVR) and enhances overall performance by sharing underlying features.</p>
</li>
<li>
<p><strong>MMOE</strong>: MMOE employs a more complex structure by introducing multiple expert networks and gating mechanisms to dynamically select suitable features and model paths for each task. Each task has its own gating network to select the most relevant information from multiple experts.</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="application-scenarios">Application Scenarios<a href="#application-scenarios" class="hash-link" aria-label="Application Scenarios的直接链接" title="Application Scenarios的直接链接">​</a></h4>
<ul>
<li>
<p><strong>ESMM</strong>: Suitable for scenarios where tasks are highly related and require extensive information sharing, particularly when data is sparse and efficient information utilization is needed.</p>
</li>
<li>
<p><strong>MMOE</strong>: More flexible and applicable to scenarios where task correlations are weaker or personalized feature selection is required. Due to its complex selection mechanism, MMOE performs better in situations with conflicting task requirements.</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="performance-aspects">Performance Aspects<a href="#performance-aspects" class="hash-link" aria-label="Performance Aspects的直接链接" title="Performance Aspects的直接链接">​</a></h4>
<ul>
<li>
<p><strong>ESMM</strong>: Provides stable performance improvements between related tasks through its simplified network architecture and efficient feature sharing.</p>
</li>
<li>
<p><strong>MMOE</strong>: Capable of offering higher prediction accuracy in complex task environments through flexible expert selection mechanisms, especially when task requirements are diverse.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="application">Application<a href="#application" class="hash-link" aria-label="Application的直接链接" title="Application的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="similarity-in-basic-structure-between-esmm-and-mmoe">Similarity in Basic Structure Between ESMM and MMOE<a href="#similarity-in-basic-structure-between-esmm-and-mmoe" class="hash-link" aria-label="Similarity in Basic Structure Between ESMM and MMOE的直接链接" title="Similarity in Basic Structure Between ESMM and MMOE的直接链接">​</a></h3>
<p>The ESMM model shares many structural similarities with the traditional MMOE model. Both employ a multi-task learning framework to enhance the performance of different tasks by sharing information. However, the ESMM model adopts a different approach in the final conversion rate prediction: it calculates the predicted Conversion Rate (pCVR) as the product of two towers, a design aimed at fully capturing the interaction between CTR and CVR.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-components-of-the-esmm-model">Key Components of the ESMM Model<a href="#key-components-of-the-esmm-model" class="hash-link" aria-label="Key Components of the ESMM Model的直接链接" title="Key Components of the ESMM Model的直接链接">​</a></h3>
<center>
<img decoding="async" loading="lazy" title="" src="../../static/images/ESMM.webp" alt="" width="400" data-align="center" class="img_ev3q">
</center>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="two-expert-networks">Two Expert Networks<a href="#two-expert-networks" class="hash-link" aria-label="Two Expert Networks的直接链接" title="Two Expert Networks的直接链接">​</a></h4>
<p>When applied to the AppS business, ESMM uses two expert networks. These expert networks are responsible for handling features related to CTR and CVR tasks, respectively. Through specialized network structures, ESMM can better extract and utilize task-specific information, thereby enhancing prediction accuracy.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="two-gating-mechanisms">Two Gating Mechanisms<a href="#two-gating-mechanisms" class="hash-link" aria-label="Two Gating Mechanisms的直接链接" title="Two Gating Mechanisms的直接链接">​</a></h4>
<p>In addition to expert networks, ESMM also employs two gating mechanisms to control the CTR and CVR tasks separately. These gating mechanisms dynamically adjust the selection and utilization of features for each task, ensuring that each task receives the most suitable information flow. Through optimization of gating mechanisms, ESMM provides more precise results in complex user behavior predictions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="experimental-results-and-effects">Experimental Results and Effects<a href="#experimental-results-and-effects" class="hash-link" aria-label="Experimental Results and Effects的直接链接" title="Experimental Results and Effects的直接链接">​</a></h2>
<p>In practical applications within the AppS business, the ESMM model has demonstrated significant results through A/B testing. In the &quot;Guess You Like&quot; module, the ESMM model successfully achieved a 6.45% increase in average distribution per user.</p>
<center>
<img decoding="async" loading="lazy" title="" src="../../static/images/ESMM-AB.png" alt="" width="522" data-align="center" class="img_ev3q">
</center>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading">Further Reading<a href="#further-reading" class="hash-link" aria-label="Further Reading的直接链接" title="Further Reading的直接链接">​</a></h2>
<p><a href="https://arxiv.org/abs/1804.07931" target="_blank" rel="noopener noreferrer">Entire Space Multi-Task Model: An Effective Approach for Estimating ... - arXiv</a></p>
<p><a href="https://easyrec.readthedocs.io/en/latest/models/esmm.html" target="_blank" rel="noopener noreferrer">ESMM — easy_rec 0.8.5 documentation</a></p>
<p><a href="https://github.com/dai08srhg/ESMM" target="_blank" rel="noopener noreferrer">GitHub - dai08srhg/ESMM: PyTorch implementation of Entire Space Multitask Model (ESMM)</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh-Hans/blog/AppS/FM">Application of FM Model in AppS</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-03-29T04:45:30.000Z">2025年3月29日</time> · <!-- -->阅读需 5 分钟</div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Introduction的直接链接" title="Introduction的直接链接">​</a></h2>
<p>Factorization Machines (FM) are powerful machine learning models, especially widely used in recommendation systems and advertising click-through rate prediction. FM models can effectively capture the cross information between features and are highly efficient and easy to implement in engineering.</p>
<center>
<img decoding="async" loading="lazy" title="" src="../../static/images/FM.jpg" alt="" width="400" data-align="center" class="img_ev3q">
</center>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-advantages-of-fm-over-linear-regression-lr">1. Advantages of FM over Linear Regression (LR)<a href="#1-advantages-of-fm-over-linear-regression-lr" class="hash-link" aria-label="1. Advantages of FM over Linear Regression (LR)的直接链接" title="1. Advantages of FM over Linear Regression (LR)的直接链接">​</a></h3>
<p>Linear Regression (LR) is a simple and intuitive model, but it cannot capture the cross and nonlinear relationships between features. The FM model introduces latent vectors to factorize features, effectively capturing second-order interactions between features. Compared to LR, FM has the following advantages:</p>
<ul>
<li><strong>Feature Interaction</strong>: FM can automatically learn interactions between features without manually constructing cross-features, leading to better performance on complex datasets.</li>
<li><strong>Model Flexibility</strong>: FM performs well in highly sparse datasets and is suitable for scenarios with a large number of categorical features.</li>
<li><strong>Strong Generalization</strong>: By factorizing features, FM can avoid overfitting, especially when the data is high-dimensional but with a small sample size.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-time-complexity-analysis-of-fm">2. Time Complexity Analysis of FM<a href="#2-time-complexity-analysis-of-fm" class="hash-link" aria-label="2. Time Complexity Analysis of FM的直接链接" title="2. Time Complexity Analysis of FM的直接链接">​</a></h3>
<p>A significant advantage of the FM model is its efficient computational capability. Although FM considers interactions between all pairs of features, its time complexity remains ($O(N)$) rather than ($O(N​^2​​)$). This is because FM simplifies the calculation of feature interactions through factorization as follows:</p>
<p>$\hat{y}(x) = w_0 + \sum_{i=1}^{N}w_ix_i + \sum_{i=1}^{N}\sum_{j=i+1}^{N} \langle v_i, v_j \rangle x_ix_j$</p>
<p>where (⟨v​i​​,v​j​​⟩) denotes the inner product of two feature latent vectors, significantly reducing computational cost. The steps are as follows:</p>
<ul>
<li><strong>Linear Term</strong>: ($\sum_{i=1}^{N}w_ix_i$), with a time complexity of ($O(N)$).</li>
<li><strong>Interaction Term</strong>: Through factorization, ($\sum_{i=1}^{N}\sum_{j=i+1}^{N} \langle v_i, v_j \rangle x_ix_j$) can be computed in ($O(N)$) time.</li>
</ul>
<p>This efficiency allows FM to maintain fast computation speeds even when handling large-scale datasets.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-ease-of-engineering-implementation">3. Ease of Engineering Implementation<a href="#3-ease-of-engineering-implementation" class="hash-link" aria-label="3. Ease of Engineering Implementation的直接链接" title="3. Ease of Engineering Implementation的直接链接">​</a></h3>
<p>The FM model not only has theoretical advantages but is also relatively simple to implement in practice, especially when developed and deployed using deep learning frameworks like PyTorch. Below is a brief explanation and example code of implementing FM using PyTorch:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="developing-and-training-fm-model-with-pytorch">Developing and Training FM Model with PyTorch<a href="#developing-and-training-fm-model-with-pytorch" class="hash-link" aria-label="Developing and Training FM Model with PyTorch的直接链接" title="Developing and Training FM Model with PyTorch的直接链接">​</a></h3>
<p>Developing an FM model with PyTorch is very straightforward, as PyTorch&#x27;s flexibility and ease of use make customizing model structures and training processes simple. Here is a simplified implementation example of an FM model:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nn </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optim </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> optim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">FactorizationMachine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n_features</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FactorizationMachine</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">linear </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n_features</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Parameter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n_features</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        linear_part </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interaction_part </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">pow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">pow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">pow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keepdim</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> linear_part </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> interaction_part</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Example usage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">n_features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Assuming 10 features</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Dimension of latent vectors</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FactorizationMachine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n_features</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">criterion </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MSELoss</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">optimizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optim</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SGD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parameters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.01</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Assuming we have some training data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">X_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n_features</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 100 samples</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">y_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Training process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">train</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> epoch </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Train for 100 epochs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zero_grad</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outputs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">X_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> criterion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outputs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loss</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">step</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">epoch</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;Epoch [</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">epoch</span><span class="token string-interpolation interpolation operator" style="color:#393A34">+</span><span class="token string-interpolation interpolation number" style="color:#36acaa">1</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/100], Loss: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">loss</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">item</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Through the above code example, it is evident that implementing the FM model with PyTorch is intuitive and flexible. Users can easily adjust model structures, optimizers, and loss functions to quickly adapt to different business needs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="application">Application<a href="#application" class="hash-link" aria-label="Application的直接链接" title="Application的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-feature-embedding-configuration">1. Feature Embedding Configuration<a href="#1-feature-embedding-configuration" class="hash-link" aria-label="1. Feature Embedding Configuration的直接链接" title="1. Feature Embedding Configuration的直接链接">​</a></h3>
<p>In our FM model, the embedding dimension for each feature is set to 10. This configuration allows us to fully capture the interactions between features without adding excessive computational overhead. Choosing the right embedding dimension is a critical step in balancing model complexity and computational efficiency.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-addressing-sample-imbalance-issues">2. Addressing Sample Imbalance Issues<a href="#2-addressing-sample-imbalance-issues" class="hash-link" aria-label="2. Addressing Sample Imbalance Issues的直接链接" title="2. Addressing Sample Imbalance Issues的直接链接">​</a></h3>
<p>During the model training process, we found a significant imbalance in the ratio of positive to negative samples, primarily due to the substantial differences in homepage exposure click data. To address this issue, we conducted two experiments:</p>
<ul>
<li>
<p><strong>Random Negative Sample Dropping</strong>: This straightforward method aims to balance the sample ratio by reducing the number of negative samples. However, our experiments showed that while this approach can somewhat alleviate the imbalance issue, it does not significantly improve model performance.</p>
</li>
<li>
<p><strong>Positive Sample Weighting</strong>: In contrast, we applied weighting to positive samples, giving them higher learning importance. This method better emphasizes genuine user interest behaviors. By adjusting sample weights, we effectively increased the model&#x27;s focus on positive samples, leading to a significant improvement in overall model performance.</p>
</li>
</ul>
<p>The experiments demonstrated that positive sample weighting outperforms random negative sample dropping. This is mainly because weighting allows us to more accurately capture user interest preferences, avoiding model bias caused by an excess of negative samples.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-data-issues-and-model-optimization">3. Data Issues and Model Optimization<a href="#3-data-issues-and-model-optimization" class="hash-link" aria-label="3. Data Issues and Model Optimization的直接链接" title="3. Data Issues and Model Optimization的直接链接">​</a></h3>
<p>During the initial model training, we encountered a critical issue: training with the full dataset did not achieve the expected results. Upon thorough investigation, we discovered that many homepage exposures used frontend caching due to network issues. These cached data were not user-initiated actions, thus interfering with the model&#x27;s learning process.</p>
<p>To resolve this issue, we differentiated the reported data on the first screen, removing the cached data. This approach ensured that the model was trained using genuine user behavior data, ultimately ensuring the effectiveness of the model once deployed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-ab-testing-results">4. AB Testing Results<a href="#4-ab-testing-results" class="hash-link" aria-label="4. AB Testing Results的直接链接" title="4. AB Testing Results的直接链接">​</a></h3>
<p>The effect of online weighting was verified through AB testing. Specific AB test screenshots will be presented here, further proving the effectiveness of our optimization strategies in practical applications. In the <strong>Guess You Like</strong> section on the homepage, the average distribution per person increased by <strong>14.8%</strong>.</p>
<center>
<img decoding="async" loading="lazy" title="" src="../../static/images/FM-AB.webp" alt="" width="522" data-align="center" class="img_ev3q">
</center>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading">Further Reading<a href="#further-reading" class="hash-link" aria-label="Further Reading的直接链接" title="Further Reading的直接链接">​</a></h2>
<p><a href="https://github.com/rixwew/pytorch-fm" target="_blank" rel="noopener noreferrer">Factorization Machine models in PyTorch - GitHub</a></p>
<p><a href="https://d2l.ai/chapter_recommender-systems/fm.html" target="_blank" rel="noopener noreferrer">Factorization Machines</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh-Hans/blog/AppS/MMOE">Application of the MMOE Model in AppS</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-03-29T04:45:30.000Z">2025年3月29日</time> · <!-- -->阅读需 5 分钟</div></header><div class="markdown"><p>In the AppS business, recommendation systems need not only to improve user Click-Through Rate (CTR) but also to enhance Conversion Rate (CVR) to achieve comprehensive user engagement and business growth. The Multi-gate Mixture-of-Experts (MMOE) model offers an efficient solution by simultaneously optimizing multiple objectives to meet these business needs.</p>
<center>
<img decoding="async" loading="lazy" title="" src="../../static/images/MMOE-origin.webp" alt="" data-align="center" width="400" class="img_ev3q">
</center>
## Introduction
<p>In the field of recommendation systems and advertising, models often need to optimize multiple objectives simultaneously, such as Click-Through Rate (CTR) and Conversion Rate (CVR). The Multi-gate Mixture-of-Experts (MMOE) model provides an effective solution by achieving better goal synergy optimization within a multi-task learning framework.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-what-is-mmoe">1. What is MMOE?<a href="#1-what-is-mmoe" class="hash-link" aria-label="1. What is MMOE?的直接链接" title="1. What is MMOE?的直接链接">​</a></h3>
<p>MMOE (Multi-gate Mixture-of-Experts) is a deep learning architecture for multi-task learning, designed to simultaneously optimize multiple related but distinct objectives. It introduces multiple &quot;expert&quot; networks and &quot;gating&quot; mechanisms to dynamically select and combine different expert outputs to meet the needs of different tasks.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="core-components">Core Components<a href="#core-components" class="hash-link" aria-label="Core Components的直接链接" title="Core Components的直接链接">​</a></h4>
<ul>
<li><strong>Expert Networks</strong>: Multiple sub-networks, each responsible for learning different representations of input features to meet the needs of different tasks.</li>
<li><strong>Gating Networks</strong>: For each task, MMOE introduces an independent gating network responsible for selecting the appropriate combination of experts for the input sample. The gating network dynamically allocates weights to each expert based on input features.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="working-principle">Working Principle<a href="#working-principle" class="hash-link" aria-label="Working Principle的直接链接" title="Working Principle的直接链接">​</a></h4>
<p>MMOE combines expert networks through the gating mechanism, enabling the model to flexibly select the most suitable feature combinations for each task while sharing basic features. This mechanism allows for the sharing of information between tasks while mitigating negative transfer effects.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-why-use-mmoe">2. Why Use MMOE?<a href="#2-why-use-mmoe" class="hash-link" aria-label="2. Why Use MMOE?的直接链接" title="2. Why Use MMOE?的直接链接">​</a></h3>
<p>In business scenarios, especially in advertising and recommendation systems, it is often necessary to optimize multiple key metrics simultaneously. For example, improving Click-Through Rate (CTR) and Conversion Rate (CVR) are common business objectives. Traditional single-task models often struggle to balance these goals, while MMOE offers an ideal solution for multi-objective optimization.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="business-goals-considering-ctr-and-cvr">Business Goals: Considering CTR and CVR<a href="#business-goals-considering-ctr-and-cvr" class="hash-link" aria-label="Business Goals: Considering CTR and CVR的直接链接" title="Business Goals: Considering CTR and CVR的直接链接">​</a></h4>
<ul>
<li>
<p><strong>Improving CTR (Click-Through Rate)</strong>: CTR is a metric that measures the ability of advertisements or recommendations to attract user clicks. Increasing CTR can directly enhance user interaction and engagement.</p>
</li>
<li>
<p><strong>Improving CVR (Conversion Rate)</strong>: CVR is a metric that measures the ability of users to complete target behaviors (such as purchases, registrations, etc.). Enhancing CVR can directly impact the business&#x27;s final revenue.</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="why-choose-mmoe">Why Choose MMOE?<a href="#why-choose-mmoe" class="hash-link" aria-label="Why Choose MMOE?的直接链接" title="Why Choose MMOE?的直接链接">​</a></h4>
<ul>
<li><strong>Task Synergy Optimization</strong>: MMOE allows for the simultaneous optimization of CTR and CVR objectives by sharing feature representations of expert networks and using independent gating mechanisms.</li>
<li><strong>Reducing Negative Transfer</strong>: Through the combination of experts and gating, MMOE effectively reduces negative transfer effects between tasks, ensuring that optimizing one objective does not significantly harm the other.</li>
<li><strong>Dynamic Adaptability</strong>: The dynamic gating mechanism of MMOE enables the model to adjust expert combinations in real-time based on input features, adapting to different user behavior patterns and preferences.</li>
</ul>
<p>MMOE demonstrates its strong adaptability and optimization performance in multi-task learning. For scenarios that require simultaneous consideration of multiple business goals, such as optimizing ad CTR and CVR, MMOE provides an efficient and flexible solution. By designing expert and gating structures wisely, MMOE can achieve more refined recommendation and advertising strategies in complex business environments.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="application">Application<a href="#application" class="hash-link" aria-label="Application的直接链接" title="Application的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="model-architecture-and-strategy">Model Architecture and Strategy<a href="#model-architecture-and-strategy" class="hash-link" aria-label="Model Architecture and Strategy的直接链接" title="Model Architecture and Strategy的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-retaining-fm-cross-strategy">1. Retaining FM Cross Strategy<a href="#1-retaining-fm-cross-strategy" class="hash-link" aria-label="1. Retaining FM Cross Strategy的直接链接" title="1. Retaining FM Cross Strategy的直接链接">​</a></h4>
<p>In the MMOE architecture, we continue to retain the original Factorization Machine (FM) cross strategy. This strategy excels in modeling low-order feature interactions, effectively capturing the basic relationship between users and content. We integrate FM&#x27;s output into the final output of MMOE to ensure full utilization of basic feature interaction information.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-expert-network-design">2. Expert Network Design<a href="#2-expert-network-design" class="hash-link" aria-label="2. Expert Network Design的直接链接" title="2. Expert Network Design的直接链接">​</a></h4>
<p>The MMOE model employs two expert networks, each focusing on learning different feature combinations. Through diversified expert network design, the model can capture user behavior patterns from different perspectives and enhance adaptability to complex data.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-gating-mechanism">3. Gating Mechanism<a href="#3-gating-mechanism" class="hash-link" aria-label="3. Gating Mechanism的直接链接" title="3. Gating Mechanism的直接链接">​</a></h4>
<p>We designed two independent gating networks responsible for optimizing CTR and CVR, respectively:</p>
<ul>
<li><strong>CTR Gating</strong>: Controls the expert combination related to click-through rate features, ensuring that recommended content can attract user clicks.</li>
<li><strong>CVR Gating</strong>: Optimizes the feature combination related to download conversion, increasing the probability of users downloading applications.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-training-strategy">4. Training Strategy<a href="#4-training-strategy" class="hash-link" aria-label="4. Training Strategy的直接链接" title="4. Training Strategy的直接链接">​</a></h4>
<p>During model training, we use click and download behaviors as task labels and design a fixed-weight loss function:</p>
<ul>
<li><strong>Loss Weight Allocation</strong>:
<ul>
<li>The loss weight for PCTR is set to 0.95, emphasizing the optimization of click behavior.</li>
<li>The loss weight for PCTCVR is set to 0.05, ensuring that download behavior receives appropriate attention.</li>
</ul>
</li>
</ul>
<p>This weight allocation ensures that CTR is the primary optimization direction while also considering the CVR objective.</p>
<center>
<img decoding="async" loading="lazy" title="" src="../../static/images/mmoe.webp" alt="" data-align="center" width="400" class="img_ev3q">
</center>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-online-inference-and-ranking">5. Online Inference and Ranking<a href="#5-online-inference-and-ranking" class="hash-link" aria-label="5. Online Inference and Ranking的直接链接" title="5. Online Inference and Ranking的直接链接">​</a></h4>
<p>During online inference, we apply the same weights to PCTR and PCVR and rank them based on the weighted scores. Through this strategy, we can balance the priorities of clicks and downloads in recommendation ranking, optimizing user experience and business metrics.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ab-testing-results">AB Testing Results<a href="#ab-testing-results" class="hash-link" aria-label="AB Testing Results的直接链接" title="AB Testing Results的直接链接">​</a></h3>
<p>By applying the MMOE model in the &quot;Guess You Like&quot; module, our AB testing results showed a <strong>13.1%</strong> increase in average distribution per user. This significant improvement validates the effectiveness of the MMOE model in simultaneously optimizing CTR and CVR, bringing higher user engagement and conversion rates to the AppS business.</p>
<center>
<img decoding="async" loading="lazy" title="" src="../../static/images/MMOE-AB.png" alt="" width="522" data-align="center" class="img_ev3q">
</center>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Conclusion的直接链接" title="Conclusion的直接链接">​</a></h3>
<p>The MMOE model achieves comprehensive optimization of CTR and CVR in the AppS business through its flexible expert and gating mechanisms. Combined with the FM cross strategy, MMOE not only enhances the predictive ability of recommendation systems but also improves multi-objective synergy optimization of user behavior, providing strong support for business development.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading">Further Reading<a href="#further-reading" class="hash-link" aria-label="Further Reading的直接链接" title="Further Reading的直接链接">​</a></h2>
<p><a href="https://dl.acm.org/doi/pdf/10.1145/3219819.3220007" target="_blank" rel="noopener noreferrer">Modeling Task Relationships in Multi-task Learning with
Multi-gate Mixture-of-Experts</a></p>
<p><a href="https://www.yuan-meng.com/posts/mtml/" target="_blank" rel="noopener noreferrer">The Annotated Multi-Task Ranker: An MMoE Code Example</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/zh-Hans/blog/AppS/intro">Applicaton Store(AppS) Introduction</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-03-29T04:45:30.000Z">2025年3月29日</time> · <!-- -->阅读需 2 分钟</div></header><div class="markdown"><p>Apps functions as a digital distribution platform similar to Apple&#x27;s AppStore or Google Play, focusing on providing users with a variety of applications and games. Our primary key performance indicator is the number of user downloads and installations, which directly reflects the platform&#x27;s usage and user satisfaction.</p>
<img decoding="async" loading="lazy" title="" src="../../static/images/appstore.jpg" alt="" width="476" data-align="center" class="img_ev3q">
<img decoding="async" loading="lazy" title="" src="../../static/images/googleplay.png" alt="" width="476" data-align="center" class="img_ev3q">
<p><strong>Current Status</strong></p>
<ol>
<li>
<p><strong>Network Adaptability</strong><br>
In situations of no network or weak network, this platform utilizes cached information to ensure that the user interface remains fully populated, avoiding blank screens. This feature enhances user experience under various network conditions.</p>
</li>
<li>
<p><strong>App and Game Distribution</strong><br>
The platform primarily distributes apps and games. With the expertise of our operational staff, these are configured for placement on different leaderboards. However, as these leaderboards are manually operated, the configuration tasks are heavy, with the homepage alone featuring more than 20 leaderboards. This results in longer onboarding cycles, typically requiring two weeks for review. This manual configuration approach leads to slow leaderboard updates and poor performance of new apps during the cold start phase, reducing overall distribution efficiency.</p>
</li>
<li>
<p><strong>Performance of &quot;Guess You Like&quot; Section</strong><br>
The &quot;You May Like&quot; section of the platform is a relatively high-traffic area, accounting for <strong>45%</strong> of the platform&#x27;s daily active users, yet it only contributes <strong>5%</strong> of the total downloads. Despite the high traffic, the limited exposure slots result in download volumes not matching the expected contribution levels.</p>
</li>
</ol>
<p><strong>Future Goals</strong></p>
<p>To enhance the number of downloads and installations, the platform plans to integrate an advanced recommendation system. Through intelligent recommendations, we aim to effectively expedite leaderboard updates and improve the exposure of new applications, thereby enhancing overall distribution efficiency and optimizing user experience.</p></div><footer class="row docusaurus-mt-lg"></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-Hans/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-Hans/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>